<!DOCTYPE html>
<html lang="{{@site.locale}}">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{meta_title}}</title>

    <!-- Wonder Cabinet Brand Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Jost:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{asset "built/screen.css"}}">

    {{#is "home"}}
        {{#if @site.cover_image}}
            <link rel="preload" as="image" href="{{@site.cover_image}}">
        {{/if}}
    {{/is}}

    <style>
        :root {
            --background-color: {{@custom.background_color}};
            {{#if @custom.galaxy_background_image}}
            --wc-galaxy-bg: url({{@custom.galaxy_background_image}});
            {{/if}}
        }
    </style>

    <script>
        /* The script for calculating the color contrast was taken from
        https://gomakethings.com/dynamically-changing-the-text-color-based-on-background-color-contrast-with-vanilla-js/ */
        var accentColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
        accentColor = accentColor.trim().slice(1);
        var r = parseInt(accentColor.substr(0, 2), 16);
        var g = parseInt(accentColor.substr(2, 2), 16);
        var b = parseInt(accentColor.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        var textColor = (yiq >= 128) ? 'dark' : 'light';

        document.documentElement.className = `has-${textColor}-text`;
    </script>

    {{#if @custom.jotform_form_id}}
    <script src="https://cdn.jotfor.ms/s/static/latest/static/feedback2.js"></script>
    {{/if}}

    {{ghost_head}}
</head>

<body class="{{body_class}}{{{block "body_class"}}}">
<div class="gh-site">

    {{!-- Skip to content link for keyboard accessibility (WCAG 2.4.1) --}}
    <a href="#main-content" class="wc-skip-link">Skip to content</a>

    {{> "components/navbar"}}

    {{{body}}}

    {{> components/footer}}

</div>

{{#is "post, page"}}
    {{> "pswp"}}
{{/is}}

<script src="{{asset "built/main.min.js"}}"></script>

{{!-- WaveSurfer.js for audio player with CDN fallback --}}
{{#is "post"}}
    <script>
    // Load WaveSurfer with timeout and fallback CDNs
    (function() {
        var cdns = [
            'https://unpkg.com/wavesurfer.js@7',
            'https://cdn.jsdelivr.net/npm/wavesurfer.js@7'
        ];
        var timeout = 5000; // 5 second timeout per CDN
        var loaded = false;
        var currentIndex = 0;

        function loadScript(url, callback, onError) {
            var script = document.createElement('script');
            var timer = setTimeout(function() {
                script.onload = script.onerror = null;
                onError(new Error('Timeout loading ' + url));
            }, timeout);

            script.onload = function() {
                clearTimeout(timer);
                callback();
            };
            script.onerror = function() {
                clearTimeout(timer);
                onError(new Error('Failed to load ' + url));
            };
            script.src = url;
            document.head.appendChild(script);
        }

        function tryNextCdn() {
            if (loaded || currentIndex >= cdns.length) {
                if (!loaded) {
                    console.warn('Wonder Cabinet: WaveSurfer.js could not be loaded from any CDN');
                    // Audio player will show graceful error state
                }
                return;
            }
            loadScript(cdns[currentIndex], function() {
                loaded = true;
                console.log('Wonder Cabinet: WaveSurfer.js loaded from', cdns[currentIndex]);
            }, function(err) {
                console.warn(err.message);
                currentIndex++;
                tryNextCdn();
            });
        }

        tryNextCdn();
    })();
    </script>
    <script src="{{asset "js/audio-player.js"}}"></script>
{{/is}}

{{#if @custom.jotform_form_id}}
{{!-- Jotform contact form lightbox popup --}}
<script>
(function() {
    var formId = '{{@custom.jotform_form_id}}';

    // Initialize Jotform lightbox (hidden â€” no floating button)
    var jfLightbox = new JotformFeedback({
        formId: formId,
        base: 'https://form.jotform.com/',
        windowTitle: 'Contact Form',
        backgroundColor: '#000000',
        fontColor: '#FFFFFF',
        type: false,
        height: 500,
        width: 700,
        openOnLoad: false
    });

    // Open lightbox when any #contact-form link is clicked
    document.addEventListener('click', function(e) {
        var link = e.target.closest('a[href*="#contact-form"]');
        if (!link) return;

        e.preventDefault();

        // Close mobile menu if open
        var mobileMenu = document.querySelector('.wc-mobile-menu');
        if (mobileMenu && mobileMenu.classList.contains('is-active')) {
            mobileMenu.classList.remove('is-active');
            document.body.classList.remove('no-scroll');
        }

        // Trigger the Jotform lightbox
        var trigger = document.querySelector('.lightbox-' + formId);
        if (trigger) {
            trigger.click();
        }
    });
})();
</script>
<script src="https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js"></script>
{{/if}}

{{ghost_foot}}

</body>

</html>
